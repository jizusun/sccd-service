<?xml version="1.0" encoding="UTF-8"?>
<con:soapui-project id="ab47f34a-0546-40b4-a095-3cd066256d79" activeEnvironment="Default" name="SendViewDetail" resourceRoot="" soapui-version="5.3.0" abortOnError="false" runType="SEQUENTIAL" xmlns:con="http://eviware.com/soapui/config"><con:settings/><con:interface xsi:type="con:RestService" id="7cb8a5f7-8135-4bc1-b127-7bf88f5eb21c" wadlVersion="http://wadl.dev.java.net/2009/02" name="Jenkins" type="rest" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings/><con:definitionCache type="TEXT" rootPart=""/><con:endpoints><con:endpoint>http://mo-2b83de737.mo.sap.corp:8080/</con:endpoint></con:endpoints><con:resource name="GetViewDetails" path="view/{Viewname}/" id="f0115fc4-e40a-46c7-9a40-cedb40f4ef22"><con:settings/><con:parameters><con:parameter><con:name>Viewname</con:name><con:style>TEMPLATE</con:style></con:parameter></con:parameters><con:resource name="" path="" id="fc4b0da6-c683-4c9f-be6b-1490c8b4bab3"><con:settings/><con:parameters/><con:method name="Method 1" id="3ebda8ef-c198-4f06-8091-7cebb65aa4c0" method="GET"><con:settings/><con:parameters/><con:representation type="FAULT"><con:mediaType>text/html;charset=iso-8859-1</con:mediaType><con:status>404</con:status><con:params/><con:element>html</con:element></con:representation><con:representation type="RESPONSE"><con:mediaType>text/html;charset=utf-8</con:mediaType><con:status>200</con:status><con:params/><con:element>html</con:element></con:representation><con:request name="Request 1" id="60096322-840a-432b-9617-75b437f5d48b" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://mo-2b83de737.mo.sap.corp:8080/</con:endpoint><con:request/><con:originalUri>http://mo-2b83de737.mo.sap.corp/All_CIA</con:originalUri><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><entry key="Viewname" value="All_CIA" xmlns="http://eviware.com/soapui/config"/></con:parameters></con:request></con:method></con:resource></con:resource></con:interface><con:testSuite id="94a576ce-2780-4745-9c48-1c3f1d2fc212" name="GetViewReport"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="048e9791-77be-4945-ab9a-92cd552b4509" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="GetAllDetails" searchProperties="true"><con:settings/><con:testStep type="restrequest" name="Jobs" id="3b8ea539-9984-4496-9575-bfe11da97d90"><con:settings/><con:config service="Jenkins" resourcePath="/view/{Viewname}/" methodName="Method 1" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="Jobs" id="60096322-840a-432b-9617-75b437f5d48b" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://mo-2b83de737.mo.sap.corp:8080/</con:endpoint><con:request/><con:originalUri>http://mo-2b83de737.mo.sap.corp/All_CIA</con:originalUri><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><entry key="Viewname" value="${#Project#Prop_Project_ViewName}" xmlns="http://eviware.com/soapui/config"/></con:parameters></con:restRequest></con:config></con:testStep><con:testStep type="groovy" name="Groovy Script" id="aed2a71c-b581-4fb5-85c2-d3808d155639"><con:settings/><con:config><script><![CDATA[import org.apache.poi.xssf.usermodel.*
import org.apache.poi.xssf.usermodel.XSSFWorkbook

def projectPath = testRunner.testCase.testSuite.project.getPath().toString()
log.info projectPath
File dummyFile = new File(projectPath)
def projectDir = dummyFile.getParent().toString()

File dummyFile2 = new File(projectDir)
def fileRoot =  dummyFile2.getCanonicalPath()
def filepath = dummyFile2.getCanonicalPath()+"//Job Assignment.xlsx"

println "read test data into properties"
def suiteName = testRunner.testCase.testSuite.project.getPropertyValue("Prop_Project_ViewName")
FileInputStream file = new FileInputStream(filepath)
XSSFWorkbook wb = new XSSFWorkbook(file)
XSSFSheet sh = wb.getSheet(suiteName)

int maxRow = sh.getPhysicalNumberOfRows()
int maxCol = sh.getRow(0).getLastCellNum()
List jobs = []
def jobTitle = ["Projects","CI Jobs","Assingee","Status"]
	for (int i=1;i<maxRow;i++){
		def project=sh.getRow(i).getCell(0).toString()
		def job = sh.getRow(i).getCell(1).toString()
		def assignee = sh.getRow(i).getCell(2).toString()
		List jobTmp = []
		jobTmp.add(project)
		jobTmp.add(job)
		jobTmp.add(assignee)
		jobs.add(jobTmp)
	}
	
file.close()

//Get response from request 
def requestUrl = context.testCase.testSteps["Jobs"].testRequest.getResponse().getURL(); 
log.info "requestUrl"+requestUrl
def response = context.testCase.testSteps["Jobs"].testRequest.response.responseContent
def regex = /<tr id="job_(.*?)" class=" job-status-(.*?)">/
def jobFromResponse = (response =~ regex)
def jobCount = jobFromResponse.size()
def jobList = []
for (jobtmp2  in jobFromResponse ){
		if (jobtmp2[2]=="blue"){
			jobtmp2[2]="Pass"
		}
		else {
			jobtmp2[2] = "Failed"
		}
		for (job in jobs){
				if (jobtmp2[1]==job[1])
				job.add(jobtmp2[2])
			}
	}
	def role = testRunner.testCase.testSuite.project.getPropertyValue("Prop_Project_Role")
	def finalJobList = []
	//Only send 
	if (role=="CIA_PO"){
		for (job in jobs ){
			if (job[1].contains("BYDC4C") || job[1].contains("CoPilot")){
			}
			else {
				finalJobList.add(job)
			}
		}
	}
else {
		finalJobList= jobs
}

String date = (new Date().format("yyyy-MM-dd"))
filepath = fileRoot+"//test.html"
File file3 = new File (filepath)
def html = "<p>Date : "+date+"</p><p>View Link: <a href=\""+requestUrl+"/\">"+requestUrl+"</a></p><table><thead><tr>"
//print header 
for (header in jobTitle){
	html+= "<td>"+header+"</td>"
}
html += "</tr></thead><tbody>"
for (job in finalJobList ){
	html += "<tr>"
	for (column in job){
		if(column == "Failed"){
			html+="<td  class=\"error\">"+ column +"</td>"
		}
		else if (column == "Pass"){
			html+="<td  class=\"pass\">"+ column +"</td>"
		}
		else {
			html += "<td>"+column+"</td>"	
		}
	}
	html += "</tr>"
}

html +="</tbody></table></body></html>"	
log.info html
file3.append(html)]]></script></con:config></con:testStep><con:properties/></con:testCase><con:properties/></con:testSuite><con:properties><con:property><con:name>Prop_Project_Role</con:name><con:value>CIA_PO</con:value></con:property><con:property><con:name>Prop_Project_ViewName</con:name><con:value>All_CIA</con:value></con:property></con:properties><con:wssContainer/><con:oAuth2ProfileContainer/><con:oAuth1ProfileContainer/><con:sensitiveInformation/></con:soapui-project>